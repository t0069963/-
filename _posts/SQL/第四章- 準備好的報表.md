## 完成本課程後，您應該能夠：
## 目標完成本課程後，您應該能夠：
完成本課程後，您應該能夠：
• 列出使用準備好的語句的原因及其限制
• 描述 SQL 注入以及準備好的語句如何幫助保護它
• 使用 mysql 命令行客戶端準備、執行和取消分配準備好的語句
• 在帶有連接器的代碼中使用準備好的語句

## 議程
• 使用準備好的語句的原因
• 用戶定義的變量
• 準備、執行和釋放準備好的語句
• 將準備好的語句與連接器一起使用

## 為什麼要使用準備好的語句？
• 提高查詢性能。 您準備一個語句並執行多次，每次使用不同的數據值。
– 服務器僅解析語句一次，當它準備語句時，為該語句創建新協議，為該語句創建新協議。
– 服務器僅解析語句一次，當它準備語句時，為該語句創建新協議，為該語句創建新協議。
— 減少服務器 CPU 開銷 
— 與單獨發送每個語句相比，減少了服務器和客戶端之間的網絡流量
• 為確保數據類型在 SQL 語句中正確引用
• 避免 SQL 注入通常，您使用連接器從程序代碼準備和執行語句。
但是，為了幫助測試和調試，您可以從 mysql 命令行客戶端中定義和執行準備好的語句。
版權所有 © 2017，Oracle 和/或其附屬公司。 版權所有。
當服務器準備一條語句時，它會為該語句創建一個協議。 通常，客戶端將 SQL 語句與值一起傳遞，這些值由服務器從原始文本字符串中解析出來。 預準備語句的協議將值與語句的其餘部分分開，並提供一種二進制機制來傳輸值。 這比在字符串之間進行轉換更有效。
準備好的語句還有助於防止一種稱為 SQL 注入的攻擊形式。 惡意的 SQL 惡意用戶可以將 SQL 命令插入到需要值的應用程序中。 準備好的語句將 SQL 命令與值分開，並防止將值解釋為 SQL 語句。
```
通常，您使用連接器從程序代碼準備和執行語句。
但是，為了幫助測試和調試，您可以從 mysql 命令行客戶端中定義和執行準備好的語句。
當服務器準備一條語句時，它會為該語句創建一個協議。 通常，客戶端將 SQL 語句與值一起傳遞，這些值由服務器從原始文本字符串中解析出來。 預準備語句的協議將值與語句的其餘部分分開，並提供一種二進制機制來傳輸值。 這比在字符串之間進行轉換更有效。
準備好的語句還有助於防止一種稱為 SQL 注入的攻擊形式。 惡意的 SQL 惡意用戶可以將 SQL 命令插入到需要值的應用程序中。 準備好的語句將 SQL 命令與值分開，並防止將值解釋為 SQL 語句。
```

## 準備報表的局限性
• 不能嵌套準備好的語句。
– 您要準備的語句不能包含 PREPARE、EXECUTE 或 DEALLOCATE PREPARE。
• 只能準備單個語句，不能準備多語句。
– 多語句由單個字符串中的多個語句組成，由終止符分隔。
• 您不能準備某些類型的報表。 例如： – LOCK TABLES/UNLOCK TABLES, LOAD DATA/LOAD TABLE, ALTER VIEW
– 診斷語句（診斷語句（SHOW ERRORS/SHOW WARNINGS SHOW ERRORS/SHOW WARNINGS）
• 不能準備包含動態游標聲明的語句。
– 這是因為 MySQL 在創建游標時會檢查游標語法/語句

```
MySQL 不允許您準備每種類型的 SQL 語句。 允許的語句列表類似於存儲例程中允許的語句。
MySQL 5.7.2及更高版本，不能按照SQL標準的要求準備診斷語句。 診斷語句包括：
• SHOW ERRORS/WARNINGS 
• SIGNAL/RESIGNAL 
• GET DIAGNOSTICS 
• 任何引用warning_count 或error_count 系統變量的語句
注意 
• 有關準備好的語句中允許的 SQL 語句的完整列表，請參閱：https://dev.mysql.com/doc/mysql/en/sql-syntax-prepared-statements.html。
• 本課程涵蓋題為“存儲例程”的課程中的存儲例程。
```

## SQL注入
SQL 注入是一種技術，惡意用戶可以通過基於表單的輸入將 SQL 命令注入到 Web 應用程序中。
示例： 
• 服務器代碼：
```
parse_str($_SERVER['QUERY_STRING']);
$sql = "SELECT * FROM Users WHERE UserId = " + $UserId;
$rs = $mysqli->query(sql);

```
• 表格輸入：
![[Pasted image 20211217092550.png]]
• 結果 SQL：
```
SELECT * FROM Users WHERE UserId = 11000 OR 1=1;
SELECT * FROM Users WHERE UserId = 22; DROP TABLE tb11;
```
```
幻燈片中的示例顯示了當 SQL 不使用參數化查詢（如預準備語句啟用的查詢）時，惡意用戶如何將可能有害的 SQL 代碼注入到基於 Web 的表單中。
在此 Web 應用程序中，用戶在 HTML 表單中的用戶 ID 文本框中輸入一個值。 瀏覽器將表單提交給服務器。  Web 應用程序檢索輸入的值，將其存儲在名為 txtUserID 的變量中，將其附加到包含 SQL 語句的字符串，然後執行查詢。
示例 1：用戶在用戶 ID 文本框中輸入 11000 OR 1=1。 當這個文本被附加到 SQL 語句中時，因為 1=1 總是為真，MySQL 服務器返回所有記錄。如果記錄是一個真正的安全風險。 如果用戶表包含密碼數據表包含密碼數據，則這是一個真正的安全風險。
例2：用戶輸入22； 刪除表 tbl1; 添加分號允許將兩條 SQL 語句作為批處理執行，其中第二條會刪除 tbl1 表並可能導致災難性的數據丟失。
準備好的語句有助於防止 SQL 注入，因為要插入 SQL 查詢的值會獨立於查詢本身發送到 MySQL 服務器。 這意味著這些值總是被解釋為數據而不是 SQL 代碼值總是被解釋為數據而不是 SQL 代碼。
```
## 用戶定義的變量
4-9





